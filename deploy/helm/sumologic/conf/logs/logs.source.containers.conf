<filter containers.**>
  @type record_transformer
  enable_ruby
  renew_record true
  <record>
    log    ${record["log"].split(/[\n\t]+/).map! {|item| JSON.parse(item)["log"]}.join("")}
    stream ${[record["log"].split(/[\n\t]+/)[0]].map! {|item| JSON.parse(item)["stream"]}.join("")}
    time   ${[record["log"].split(/[\n\t]+/)[0]].map! {|item| JSON.parse(item)["time"]}.join("")}
  </record>
</filter>
<match containers.**>
  @type relabel
  @label @NORMAL
</match>
<label @NORMAL>
  <filter containers.**>
    @type kubernetes_metadata
    @log_level warn
    annotation_match ["sumologic\.com.*"]
    de_dot false
    watch {{ .Values.fluentd.logs.containers.k8sMetadataFilter.watch | quote }}
    ca_file {{ .Values.fluentd.logs.containers.k8sMetadataFilter.caFile | quote }}
    verify_ssl {{ .Values.fluentd.logs.containers.k8sMetadataFilter.verifySsl | quote }}
    client_cert {{ .Values.fluentd.logs.containers.k8sMetadataFilter.clientCert | quote }}
    client_key {{ .Values.fluentd.logs.containers.k8sMetadataFilter.clientKey | quote }}
    bearer_token_file {{ .Values.fluentd.logs.containers.k8sMetadataFilter.bearerTokenFile | quote }}
    cache_size {{ .Values.fluentd.logs.containers.k8sMetadataFilter.bearerCacheSize | quote }}
    cache_ttl {{ .Values.fluentd.logs.containers.k8sMetadataFilter.bearerCacheTtl | quote }}
    tag_to_kubernetes_name_regexp '.+?\.containers\.(?<pod_name>[^_]+)_(?<namespace>[^_]+)_(?<container_name>.+)-(?<docker_id>[a-z0-9]{64})\.log$'
{{- .Values.fluentd.logs.containers.k8sMetadataFilter.extraConf | nindent 6 }}
  </filter>
  <filter **>
    @type enhance_k8s_metadata
    in_namespace_path '$.kubernetes.namespace_name'
    in_pod_path '$.kubernetes.pod_name'
    data_type logs
  </filter>
  <filter containers.**>
    @type kubernetes_sumologic
    source_name "#{ENV['SOURCE_NAME']}"
    source_host "#{ENV['SOURCE_HOST']}"
    log_format "#{ENV['LOG_FORMAT']}"
    kubernetes_meta "#{ENV['KUBERNETES_META']}"
    kubernetes_meta_reduce "#{ENV['KUBERNETES_META_REDUCE']}"
    add_stream "#{ENV['ADD_STREAM']}"
    add_time "#{ENV['ADD_TIME']}"
    source_category "#{ENV['SOURCE_CATEGORY']}"
    source_category_prefix "#{ENV['SOURCE_CATEGORY_PREFIX']}"
    source_category_replace_dash "#{ENV['SOURCE_CATEGORY_REPLACE_DASH']}"
    exclude_namespace_regex "#{ENV['EXCLUDE_NAMESPACE_REGEX']}"
    exclude_pod_regex "#{ENV['EXCLUDE_POD_REGEX']}"
    exclude_container_regex "#{ENV['EXCLUDE_CONTAINER_REGEX']}"
    exclude_host_regex "#{ENV['EXCLUDE_HOST_REGEX']}"
  </filter>
  <match **>
    @type sumologic
    @id sumologic.endpoint.logs
{{- .Values.fluentd.logs.containers.outputConf | nindent 6 }}
  </match>
</label>